#!@@SHELL@@
#  cue2mp3.sh
#  
#  Copyright 2017 Nathan Fisher <nfisher.sr@gmail.com>
#  
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#  
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#  
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
#  MA 02110-1301, USA.
#  
#  

cat<<EOF

Copyright (C) 2017 Nathan Fisher
cue2mp3.sh comes with ABSOLUTELY NO WARRANTY.  This program is free
software. You are welcome to redistribute it under certain conditions.
EOF

# Get our canonical prefix and read in functions
SELF="$0"
BINDIR="${SELF%/*}"
PREFIX="${BINDIR%/*}"
. $PREFIX/etc/audioct.conf

# Read argument
CUE="$1"
[ "$CUE" = "" ] && exit 1
FILE="$(grep 'FILE ' "$CUE" | head -n 1 | cut -f 2 -d '"')"

TL="$(grep 'TITLE ' "${CUE}" | head -n 1 | cut -f 2 -d '"')"
TA="$(grep 'PERFORMER ' "${CUE}" | head -n 1 | cut -f 2 -d '"')"
TY="$(grep 'DATE ' "${CUE}" | head -n 1 | sed -e 's:REM ::' -e 's:DATE ::')"
TG="$(grep 'GENRE ' "${CUE}" | head -n 1 | sed -e 's:REM ::' -e 's:GENRE ::')"

[ "$TL" = "" ] && TL=unknown
[ "$TA" = "" ] && TA=unknown
[ "$TY" = "" ] && TY=1900
[ "$TG" = "" ] && TG=Rock

shnsplit -f "$CUE" -t "%n - %t" "$FILE"
[ "$remove_source" = "true" ] && rm -rf "$FILE" "$CUE" || true
TTN="$(find . -maxdepth 1 -type f -name '*.wav' | grep -v "$(FILE)" \
  | wc -l)"

while read w
  do name="$(basename "$w" .wav)"
  TN="$(cut -f 1 -d ' ' <<< $name)/$TTL"
  TT="$(cut -f 3- -d ' ' <<< $name)"
  lame --preset ${lame_preset} --tt "$TT" --tn "$TN" --tl "$TL" \
    --ta "$TA" --ty "$TY" --tg "$TG" "${w}" "${name}.mp3"
  [ "$remove_source" = "true" ] && rm -rf "$w" || true
done <<< $(ls -1 *.wav | grep -v "$FILE")
